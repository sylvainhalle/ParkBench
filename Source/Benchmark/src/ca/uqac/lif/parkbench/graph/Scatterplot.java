package ca.uqac.lif.parkbench.graph;

import java.util.HashSet;
import java.util.Set;
import java.util.Vector;

import ca.uqac.lif.parkbench.Parameters;
import ca.uqac.lif.parkbench.Test;

public class Scatterplot extends GnuPlot
{
	/**
	 * The name of the parameter to use as the "x" value of the plot
	 */
	protected String m_paramNameX = "";
	
	/**
	 * The name of the parameter to use as the "y" value of the plot
	 */
	protected String m_paramNameY = "";
	
	/**
	 * The caption for the x-axis
	 */
	protected String m_captionX = "";
	
	/**
	 * The caption for the y-axis
	 */
	protected String m_captionY = "";
	
	/**
	 * Creates an empty scatterplot with title
	 * @param title The title
	 */
	public Scatterplot(String title)
	{
		super(title);
	}
	
	/**
	 * Set the name of the parameter to use as the "x" value of the
	 * plot
	 * @param name The parameter name
	 */
	public void setParameterX(String name)
	{
		m_paramNameX = name;
	}

	/**
	 * Set the name of the parameter to use as the "y" value of the
	 * plot
	 * @param name The parameter name
	 */
	public void setParameterY(String name)
	{
		m_paramNameY = name;
	}
	
	@Override
	public String toGnuPlot(Terminal term)
	{
		// Build the set of parameters to group by (x)
		Set<String> group_by = new HashSet<String>();
		group_by.add(m_paramNameX);
		// Fill a 2D map with data
		Map2D<Number,Parameters,Number> map = new Map2D<Number,Parameters,Number>();
		for (Test t : m_tests)
		{
			Parameters params = new Parameters(t.getParameters());
			// Put test's name into params
			params.put("name", t.getName());
			Number value_x = (Number) params.get(m_paramNameX);
			params.removeAll(group_by);
			Parameters results = t.getResults();
			Number value_y = (Number) results.getNumber(m_paramNameY);
			map.put(value_x, params, value_y);
		}
		// Create plot string
		StringBuilder out = new StringBuilder();
		out.append("# File auto-generated by ParkBench\n");
		out.append("set terminal ").append(getTerminalString(term)).append("\n");
		out.append("set title \"").append(m_title).append("\"\n");
		out.append("set datafile separator \",\"\n");
		//out.append("set x-axis title \"").append(m_captionX).append("\"\n");
		//out.append("set y-axis title \"").append(m_captionX).append("\"\n");
		out.append("plot ");
		int column_count = 2;
		Vector<Parameters> columns = map.getColumns();
		String csv_data = map.toCsv();
		StringBuilder data_part = new StringBuilder();
		for (Parameters p : columns)
		{
			if (column_count > 2)
			{
				out.append(", ");
			}
			//out.append("\"-\" using 1:").append(column_count).append(" with linespoints");
			out.append("\"-\" using 1:").append(column_count).append(" with points");
			column_count++;
			// In Gnuplot, if we use the special "-" filename, we must repeat
			// the data as many times as we use it in the plot command; it does not remember it
			data_part.append(csv_data).append("\nend\n");
		}
		out.append("\n");
		out.append(data_part);
		return out.toString();
	}
}
